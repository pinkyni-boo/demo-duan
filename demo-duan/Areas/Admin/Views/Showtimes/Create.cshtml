@model demo_duan.Models.Showtime
@{
    ViewData["Title"] = "Tạo Suất chiếu mới";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1"><i class="fas fa-calendar-plus me-2 text-primary"></i>Tạo Suất chiếu mới</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/Admin">Admin</a></li>
                <li class="breadcrumb-item"><a href="/Admin/Showtimes">Showtimes</a></li>
                <li class="breadcrumb-item active">Create</li>
            </ol>
        </nav>
    </div>
    <a asp-action="Index" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>Quay lại
    </a>
</div>

<!-- Display Validation Summary -->
@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Vui lòng kiểm tra lại thông tin:</strong>
        <ul class="mb-0 mt-2">
            @foreach (var modelError in ViewData.ModelState)
            {
                foreach (var error in modelError.Value.Errors)
                {
                    <li>@error.ErrorMessage</li>
                }
            }
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card admin-card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>Thông tin suất chiếu
                </h6>
            </div>
            <div class="card-body">
                <form asp-action="Create" method="post" id="showtimeForm" novalidate>
                    <div class="row">
                        <!-- Movie Selection -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="MovieId" class="form-label required">
                                <i class="fas fa-film me-1 text-primary"></i>Chọn phim
                            </label>
                            <select asp-for="MovieId" class="form-select" asp-items="ViewBag.MovieId" required>
                                <option value="">-- Chọn phim --</option>
                            </select>
                            <span asp-validation-for="MovieId" class="text-danger"></span>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>Chọn phim sẽ chiếu
                            </div>
                        </div>

                        <!-- Theater Selection -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label required">
                                <i class="fas fa-building me-1 text-success"></i>Chọn rạp
                            </label>
                            <select id="TheaterId" name="TheaterId" class="form-select" required>
                                <option value="">-- Chọn rạp chiếu phim --</option>
                                @if (ViewBag.TheaterId != null)
                                {
                                    @foreach (var theater in (SelectList)ViewBag.TheaterId)
                                    {
                                        <option value="@theater.Value">@theater.Text</option>
                                    }
                                }
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>Chọn rạp sẽ chiếu phim
                            </div>
                        </div>
                    </div>

                    <!-- Cinema Selection Row -->
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label asp-for="CinemaId" class="form-label required">
                                <i class="fas fa-video me-1 text-info"></i>Chọn phòng chiếu
                            </label>
                            <select asp-for="CinemaId" id="CinemaId" class="form-select" required>
                                <option value="">-- Vui lòng chọn rạp trước --</option>
                            </select>
                            <span asp-validation-for="CinemaId" class="text-danger"></span>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>Phòng chiếu thuộc rạp đã chọn
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Date Selection -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="Date" class="form-label required">
                                <i class="fas fa-calendar me-1 text-warning"></i>Ngày chiếu
                            </label>
                            <input asp-for="Date" class="form-control" type="date" required 
                                   min="@DateTime.Today.ToString("yyyy-MM-dd")" 
                                   max="@DateTime.Today.AddDays(90).ToString("yyyy-MM-dd")" />
                            <span asp-validation-for="Date" class="text-danger"></span>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>Ngày chiếu phải từ hôm nay trở đi
                            </div>
                        </div>

                        <!-- Time Selection -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="Time" class="form-label required">
                                <i class="fas fa-clock me-1 text-info"></i>Giờ chiếu
                            </label>
                            <select asp-for="Time" class="form-select" required>
                                <option value="">-- Chọn giờ chiếu --</option>
                                <option value="08:00:00">08:00 - Suất sáng sớm</option>
                                <option value="10:30:00">10:30 - Suất sáng</option>
                                <option value="13:00:00">13:00 - Suất trưa</option>
                                <option value="15:30:00">15:30 - Suất chiều</option>
                                <option value="18:00:00">18:00 - Suất tối</option>
                                <option value="20:30:00">20:30 - Suất tối muộn</option>
                                <option value="22:45:00">22:45 - Suất đêm</option>
                            </select>
                            <span asp-validation-for="Time" class="text-danger"></span>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>Chọn khung giờ chiếu phù hợp
                            </div>
                        </div>
                    </div>

                    <!-- Seats Information -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="TotalSeats" class="form-label">
                                <i class="fas fa-chair me-1 text-secondary"></i>Tổng số ghế
                            </label>
                            <input asp-for="TotalSeats" id="TotalSeats" class="form-control" type="number" readonly 
                                   placeholder="Sẽ tự động cập nhật khi chọn phòng chiếu" />
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>Tự động lấy từ thông tin phòng chiếu
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label asp-for="AvailableSeats" class="form-label">
                                <i class="fas fa-chair me-1 text-success"></i>Ghế có sẵn
                            </label>
                            <input asp-for="AvailableSeats" id="AvailableSeats" class="form-control" type="number" 
                                   min="0" max="1000" placeholder="Mặc định bằng tổng số ghế" />
                            <span asp-validation-for="AvailableSeats" class="text-danger"></span>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>Có thể điều chỉnh nếu cần hạn chế số ghế
                            </div>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div class="alert alert-light border" id="previewSection" style="display: none;">
                        <h6 class="alert-heading"><i class="fas fa-eye me-2"></i>Xem trước thông tin</h6>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Phim:</strong> <span id="previewMovie">-</span></p>
                                <p><strong>Rạp:</strong> <span id="previewTheater">-</span></p>
                                <p><strong>Phòng chiếu:</strong> <span id="previewCinema">-</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Ngày chiếu:</strong> <span id="previewDate">-</span></p>
                                <p><strong>Giờ chiếu:</strong> <span id="previewTime">-</span></p>
                                <p><strong>Số ghế:</strong> <span id="previewSeats">-</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-outline-info" onclick="previewShowtime()">
                            <i class="fas fa-eye me-1"></i>Xem trước
                        </button>
                        <button type="submit" class="btn btn-admin-success">
                            <i class="fas fa-save me-1"></i>Tạo suất chiếu
                        </button>
                        <a asp-action="Index" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Hủy
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .required::after {
            content: " *";
            color: red;
        }
        
        .form-select:focus,
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .admin-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }
        
        .btn-admin-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            transition: transform 0.3s ease;
        }
        
        .btn-admin-success:hover {
            transform: translateY(-2px);
            color: white;
        }
        
        .is-invalid {
            border-color: #dc3545;
        }
        
        .alert-notification {
            animation: slideInRight 0.3s ease-out;
        }
        
        /* Keyframes phải được đặt trong CSS, không phải Razor */
        @@keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 5px;
        }
        
        @@keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
}

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Load cinemas when theater changes
            $('#TheaterId').change(function() {
                var theaterId = $(this).val();
                var $cinemaSelect = $('#CinemaId');
                
                // Reset cinema dropdown
                $cinemaSelect.empty().append('<option value="">-- Chọn phòng chiếu --</option>');
                
                // Reset seats
                $('#TotalSeats').val('');
                $('#AvailableSeats').val('');
                
                if (theaterId) {
                    // Show loading with spinner
                    $cinemaSelect.html('<option value=""><span class="loading-spinner"></span>Đang tải phòng chiếu...</option>');
                    
                    // Load cinemas via AJAX
                    $.get('/Admin/Showtimes/GetCinemasByTheater', { theaterId: theaterId })
                        .done(function(data) {
                            // Clear loading message
                            $cinemaSelect.empty().append('<option value="">-- Chọn phòng chiếu --</option>');
                            
                            if (data && data.length > 0) {
                                $.each(data, function(index, cinema) {
                                    var optionText = cinema.name + ' (' + cinema.seats + ' ghế)';
                                    if (cinema.type) {
                                        optionText += ' - ' + cinema.type;
                                    }
                                    
                                    $cinemaSelect.append(
                                        $('<option></option>')
                                            .val(cinema.id)
                                            .text(optionText)
                                            .data('seats', cinema.seats)
                                    );
                                });
                                
                                // Show success message
                                showMessage('success', 'Đã tải ' + data.length + ' phòng chiếu thành công');
                            } else {
                                $cinemaSelect.append('<option value="" disabled>Rạp này chưa có phòng chiếu nào</option>');
                                showMessage('warning', 'Rạp này chưa có phòng chiếu nào');
                            }
                        })
                        .fail(function(xhr, status, error) {
                            console.error('AJAX Error:', error);
                            $cinemaSelect.empty().append('<option value="" disabled>Lỗi khi tải phòng chiếu</option>');
                            showMessage('error', 'Lỗi khi tải danh sách phòng chiếu. Vui lòng thử lại.');
                        });
                } else {
                    $cinemaSelect.empty().append('<option value="">-- Vui lòng chọn rạp trước --</option>');
                }
            });

            // Auto-calculate seats when cinema changes
            $('#CinemaId').change(function() {
                var selectedOption = $(this).find('option:selected');
                if (selectedOption.val()) {
                    var seats = selectedOption.data('seats');
                    if (seats) {
                        $('#TotalSeats').val(seats);
                        $('#AvailableSeats').val(seats);
                        showMessage('info', 'Đã cập nhật số ghế: ' + seats);
                    }
                } else {
                    $('#TotalSeats').val('');
                    $('#AvailableSeats').val('');
                }
            });

            // Form validation
            $('#showtimeForm').on('submit', function(e) {
                let isValid = true;
                
                // Check required fields
                const requiredFields = ['MovieId', 'TheaterId', 'CinemaId', 'Date', 'Time'];
                
                requiredFields.forEach(function(fieldId) {
                    const field = $('#' + fieldId);
                    if (!field.val() || field.val() === '') {
                        field.addClass('is-invalid');
                        isValid = false;
                    } else {
                        field.removeClass('is-invalid');
                    }
                });
                
                if (!isValid) {
                    e.preventDefault();
                    e.stopPropagation();
                    showMessage('error', 'Vui lòng điền đầy đủ thông tin bắt buộc!');
                    $('html, body').animate({ scrollTop: 0 }, 500);
                }
            });

            // Remove invalid class when user starts typing
            $('.form-select, .form-control').on('change input', function() {
                $(this).removeClass('is-invalid');
            });
        });

        // Show message function
        function showMessage(type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'warning' ? 'alert-warning' : 
                              type === 'error' ? 'alert-danger' : 'alert-info';
            
            const icon = type === 'success' ? 'fas fa-check-circle' : 
                        type === 'warning' ? 'fas fa-exclamation-triangle' : 
                        type === 'error' ? 'fas fa-times-circle' : 'fas fa-info-circle';
            
            // Remove existing notifications
            $('.alert-notification').remove();
            
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show alert-notification position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
                    <i class="${icon} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>`;
            
            $('body').append(alertHtml);
            
            // Auto dismiss after 4 seconds
            setTimeout(function() {
                $('.alert-notification').fadeOut(300, function() {
                    $(this).remove();
                });
            }, 4000);
        }

        // Preview functionality
        function previewShowtime() {
            const movieSelect = document.getElementById('MovieId');
            const theaterSelect = document.getElementById('TheaterId');
            const cinemaSelect = document.getElementById('CinemaId');
            const dateInput = document.getElementById('Date');
            const timeSelect = document.getElementById('Time');
            const totalSeats = document.getElementById('TotalSeats');
            
            const movieText = movieSelect.options[movieSelect.selectedIndex]?.text || '-';
            const theaterText = theaterSelect.options[theaterSelect.selectedIndex]?.text || '-';
            const cinemaText = cinemaSelect.options[cinemaSelect.selectedIndex]?.text || '-';
            const dateValue = dateInput.value || '-';
            const timeText = timeSelect.options[timeSelect.selectedIndex]?.text || '-';
            const seatsValue = totalSeats.value || '-';
            
            document.getElementById('previewMovie').textContent = movieText;
            document.getElementById('previewTheater').textContent = theaterText;
            document.getElementById('previewCinema').textContent = cinemaText;
            document.getElementById('previewDate').textContent = dateValue ? new Date(dateValue).toLocaleDateString('vi-VN') : '-';
            document.getElementById('previewTime').textContent = timeText;
            document.getElementById('previewSeats').textContent = seatsValue + ' ghế';
            
            document.getElementById('previewSection').style.display = 'block';
            
            // Scroll to preview section
            document.getElementById('previewSection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }

        // Auto-preview when all fields are filled
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('select[required], input[required]');
            
            inputs.forEach(input => {
                input.addEventListener('change', function() {
                    let allFilled = true;
                    inputs.forEach(inp => {
                        if (!inp.value) allFilled = false;
                    });
                    
                    if (allFilled) {
                        setTimeout(() => previewShowtime(), 300); // Small delay for better UX
                    }
                });
            });
        });
    </script>
}